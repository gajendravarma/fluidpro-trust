{% extends 'base.html' %}

{% block title %}Datto Backup Management - Customer Portal{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-shield-alt text-warning"></i> Datto Backup Management
            </h1>
            <p class="text-muted mb-0">Comprehensive Backup & Recovery Dashboard</p>
        </div>
    </div>

    <!-- Controls -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-cogs"></i> Dashboard Controls
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="loadData('all')">
                        <i class="fas fa-chart-bar"></i> Load All Data
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" onclick="loadData('bcdr_devices')">
                        <i class="fas fa-desktop"></i> BCDR Devices
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" onclick="loadData('bcdr_agents')">
                        <i class="fas fa-users"></i> BCDR Agents
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" onclick="loadData('dtc_assets')">
                        <i class="fas fa-cloud"></i> DTC Assets
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" onclick="loadData('dtc_storage')">
                        <i class="fas fa-hdd"></i> Storage Pool
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearData()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4" id="stats-section" style="display:none;">
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Devices</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-devices">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-desktop fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Agents</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-agents">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">DTC Assets</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-assets">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-cloud fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Online Systems</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="online-status">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card shadow mb-4" id="devices-card" style="display:none;">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-desktop"></i> BCDR Devices
                    </h6>
                    <span class="badge bg-primary" id="devices-count">0</span>
                </div>
                <div class="card-body" id="devices-content"></div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow mb-4" id="agents-card" style="display:none;">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-users"></i> BCDR Agents
                    </h6>
                    <span class="badge bg-success" id="agents-count">0</span>
                </div>
                <div class="card-body" id="agents-content"></div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow mb-4" id="assets-card" style="display:none;">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-cloud"></i> DTC Assets
                    </h6>
                    <span class="badge bg-info" id="assets-count">0</span>
                </div>
                <div class="card-body" id="assets-content"></div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow mb-4" id="storage-card" style="display:none;">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-hdd"></i> Storage Pool Usage
                    </h6>
                </div>
                <div class="card-body" id="storage-content"></div>
            </div>
        </div>
    </div>
</div>

    <script>
        let globalStats = { devices: 0, agents: 0, assets: 0, online: 0 };

        function loadData(type) {
            const cards = ['devices-card', 'agents-card', 'assets-card', 'storage-card'];
            const contents = ['devices-content', 'agents-content', 'assets-content', 'storage-content'];
            
            if (type === 'all') {
                cards.forEach(card => document.getElementById(card).style.display = 'block');
                contents.forEach(content => document.getElementById(content).innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
                document.getElementById('stats-section').style.display = 'flex';
            } else {
                const cardMap = {
                    'bcdr_devices': 'devices-card',
                    'bcdr_agents': 'agents-card',
                    'dtc_assets': 'assets-card',
                    'dtc_storage': 'storage-card'
                };
                const contentMap = {
                    'bcdr_devices': 'devices-content',
                    'bcdr_agents': 'agents-content',
                    'dtc_assets': 'assets-content',
                    'dtc_storage': 'storage-content'
                };
                
                if (cardMap[type]) {
                    document.getElementById(cardMap[type]).style.display = 'block';
                    document.getElementById(contentMap[type]).innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
                }
            }

            fetch(`/datto/api/data/?type=${type}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    displayData(data);
                    updateStats(data);
                })
                .catch(error => {
                    contents.forEach(content => {
                        const elem = document.getElementById(content);
                        if (elem && elem.innerHTML.includes('Loading')) {
                            elem.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
                        }
                    });
                });
        }

        function updateStats(data) {
            if (data.bcdr_devices) {
                const devices = data.bcdr_devices.items || data.bcdr_devices;
                globalStats.devices = devices.length;
                globalStats.online += devices.filter(d => d.online || d.status === 'paired').length;
            }
            if (data.bcdr_agents) {
                const agents = data.bcdr_agents.clients || data.bcdr_agents;
                globalStats.agents = agents.length;
                globalStats.online += agents.filter(a => a.status === 'active' || a.status === 'paired').length;
            }
            if (data.dtc_assets) {
                const assets = data.dtc_assets.items || data.dtc_assets;
                globalStats.assets = assets.length;
                globalStats.online += assets.filter(a => a.status === 'paired').length;
            }

            document.getElementById('total-devices').textContent = globalStats.devices;
            document.getElementById('total-agents').textContent = globalStats.agents;
            document.getElementById('total-assets').textContent = globalStats.assets;
            document.getElementById('online-status').textContent = globalStats.online;
        }

        function displayData(data) {
            if (data.bcdr_devices) {
                const devices = data.bcdr_devices.items || data.bcdr_devices;
                document.getElementById('devices-count').textContent = devices.length;
                document.getElementById('devices-content').innerHTML = formatDevices(devices);
            }
            if (data.bcdr_agents) {
                const agents = data.bcdr_agents.clients || data.bcdr_agents;
                document.getElementById('agents-count').textContent = agents.length;
                document.getElementById('agents-content').innerHTML = formatAgents(agents);
            }
            if (data.dtc_assets) {
                const assets = data.dtc_assets.items || data.dtc_assets;
                document.getElementById('assets-count').textContent = assets.length;
                document.getElementById('assets-content').innerHTML = formatAssets(assets);
            }
            if (data.dtc_storage) {
                const storage = Array.isArray(data.dtc_storage) ? data.dtc_storage[0] : data.dtc_storage;
                document.getElementById('storage-content').innerHTML = formatStorage(storage);
            }
        }

        function formatDevices(devices) {
            if (!devices || !devices.length) return '<div class="text-center text-muted py-4">No devices found</div>';
            return devices.map(device => `
                <div class="border-start border-primary border-4 bg-light p-3 mb-3 rounded">
                    <h6 class="mb-2"><i class="fas fa-desktop text-primary"></i> ${device.name || device.serialNumber || device.hostname || 'Unknown Device'}</h6>
                    <div class="row">
                        <div class="col-sm-6"><small class="text-muted">Serial:</small> ${device.serialNumber || 'N/A'}</div>
                        <div class="col-sm-6"><small class="text-muted">Model:</small> ${device.model || device.smbiosName || 'N/A'}</div>
                        <div class="col-12 mt-1">
                            <span class="badge ${device.online || device.status === 'paired' ? 'bg-success' : 'bg-danger'}">
                                ${device.online || device.status === 'paired' ? 'Online' : 'Offline'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatAgents(agents) {
            if (!agents || !agents.length) return '<div class="text-center text-muted py-4">No agents found</div>';
            return agents.map(agent => `
                <div class="border-start border-success border-4 bg-light p-3 mb-3 rounded">
                    <h6 class="mb-2"><i class="fas fa-user text-success"></i> ${agent.name || agent.hostname || agent.clientName || 'Unknown Agent'}</h6>
                    <div class="row">
                        <div class="col-sm-6"><small class="text-muted">Type:</small> ${agent.type || agent.clientType || 'N/A'}</div>
                        <div class="col-sm-6"><small class="text-muted">OS:</small> ${agent.os || agent.operatingSystem || 'N/A'}</div>
                        <div class="col-12 mt-1">
                            <span class="badge ${agent.status === 'active' || agent.status === 'paired' ? 'bg-success' : 'bg-danger'}">
                                ${agent.status === 'active' || agent.status === 'paired' ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatAssets(assets) {
            if (!assets || !assets.length) return '<div class="text-center text-muted py-4">No assets found</div>';
            return assets.map(asset => `
                <div class="border-start border-info border-4 bg-light p-3 mb-3 rounded">
                    <h6 class="mb-2"><i class="fas fa-cloud text-info"></i> ${asset.name || asset.hostname || 'Unknown Asset'}</h6>
                    <div class="row">
                        <div class="col-sm-6"><small class="text-muted">UUID:</small> ${asset.assetUuid || asset.uuid || 'N/A'}</div>
                        <div class="col-sm-6"><small class="text-muted">Type:</small> ${asset.type || 'N/A'}</div>
                        <div class="col-sm-6 mt-1">
                            <span class="badge ${asset.status === 'paired' ? 'bg-success' : 'bg-danger'}">
                                ${asset.status === 'paired' ? 'Paired' : 'Unpaired'}
                            </span>
                        </div>
                        <div class="col-sm-6 mt-1"><small class="text-muted">Last Backup:</small> ${asset.lastBackup ? new Date(asset.lastBackup * 1000).toLocaleDateString() : 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }

        function formatStorage(storage) {
            if (!storage) return '<div class="text-center text-muted py-4">No storage data available</div>';
            const available = storage.availableStorage || storage.available || 0;
            const used = storage.usedStorage || storage.used || 0;
            const total = storage.totalStorage || (available + used) || 0;
            const usagePercent = total > 0 ? Math.round((used / total) * 100) : 0;
            
            return `
                <div class="border-start border-warning border-4 bg-light p-3 rounded">
                    <h6 class="mb-3"><i class="fas fa-hdd text-warning"></i> ${storage.poolName || 'Default Pool'}</h6>
                    <div class="row mb-3">
                        <div class="col-sm-4"><small class="text-muted">Available:</small><br><strong>${available} GB</strong></div>
                        <div class="col-sm-4"><small class="text-muted">Used:</small><br><strong>${used} GB</strong></div>
                        <div class="col-sm-4"><small class="text-muted">Total:</small><br><strong>${total} GB</strong></div>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${usagePercent > 80 ? 'bg-danger' : usagePercent > 60 ? 'bg-warning' : 'bg-success'}" 
                             style="width: ${usagePercent}%">${usagePercent}%</div>
                    </div>
                </div>
            `;
        }

        function clearData() {
            const cards = ['devices-card', 'agents-card', 'assets-card', 'storage-card'];
            cards.forEach(card => document.getElementById(card).style.display = 'none');
            document.getElementById('stats-section').style.display = 'none';
            globalStats = { devices: 0, agents: 0, assets: 0, online: 0 };
        }
    </script>
{% endblock %}
